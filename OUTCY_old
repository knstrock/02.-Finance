from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackContext, CallbackQueryHandler
import telegram.error

# Initialize Google Sheets API
SCOPES = ['https://www.googleapis.com/auth/spreadsheets']
credentials = Credentials.from_service_account_file('total-vertex-397319-a26ac8a48653.json', scopes=SCOPES)
service = build('sheets', 'v4', credentials=credentials)
sheet = service.spreadsheets()


def start(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    message = update.message or query.message  # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ query.message, ÐµÑÐ»Ð¸ update.message None

    keyboard = [
        [InlineKeyboardButton("ðŸ“‹Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ð¹", callback_data="show_events")],
        [InlineKeyboardButton("ðŸ‘¤Ð›Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚", callback_data="personal_cabinet")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    text = ('ðŸŽ¥ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÑƒÐ»ÑŒÑ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÐ¼Ñ‹ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¼ÐµÑÑ‚Ð°Ñ… Ð›Ð¸Ð¼Ð°ÑÑÐ¾Ð»Ð°. \n'
            'Ð¡Ð»ÐµÐ´Ð¸Ñ‚Ðµ Ð·Ð° Ð°Ñ„Ð¸ÑˆÐµÐ¹\n'
            'ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ: Ñ€ÐµÐ²Ð¾Ð»ÑŽÑ‚ @aleksa74gd\n'
            'Ð§Ð°Ñ‚: https://t.me/outdoor_cinema_cy\n'
            'Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾, Ð°Ñ€ÐµÐ½Ð´Ð° Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ @limarockstar\n'
            'ðŸ‡¨ðŸ‡¾ÐšÐ¸Ð¿Ñ€, Ð›Ð¸Ð¼Ð°ÑÑÐ¾Ð»\n'
            'Ð‘Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ðµ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ:')

    if query:
        query.edit_message_text(text, reply_markup=reply_markup)
    else:
        message.reply_text(text, reply_markup=reply_markup)


def show_personal_cabinet(update: Update, context: CallbackContext):
    delete_last_message(context, update)
    query = update.callback_query
    user = update.effective_user
    user_id = f"@{user.username}" if user.username else str(user.id)

    user_bookings = fetch_user_bookings(user_id)

    text = f"ðŸ‘¤Ð›Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚\nÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ: {user.full_name}\n"

    has_active_bookings = False  # Ð¤Ð»Ð°Ð³ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¹
    if user_bookings:
        for event_name, payment_status in user_bookings.items():
            for status, tickets_count in payment_status.items():
                if tickets_count > 0:
                    if not has_active_bookings:
                        text += "\n"  # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð·
                    text += f"ðŸŽ¬{event_name}\n{status}: {tickets_count} Ð±Ð¸Ð»ÐµÑ‚Ð°\n"
                    has_active_bookings = True

    keyboard = [
        [InlineKeyboardButton("ðŸ”™ÐÐ°Ð·Ð°Ð´", callback_data="main_menu")]
    ]

    if has_active_bookings:
        for event_name in user_bookings.keys():
            keyboard.append([InlineKeyboardButton(f"âŒÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ {event_name}", callback_data=f"cancel:{event_name}")])

    reply_markup = InlineKeyboardMarkup(keyboard)
    query.edit_message_text(text, reply_markup=reply_markup)



def show_events(update: Update, context: CallbackContext, message_id=None):
    events = fetch_events()
    registered_count = fetch_registered_users_count()
    keyboard = []
    for event in events:
        event_name = event['name']
        event_date = event['date']
        count = registered_count.get(event_name, 0)
        button_text = f"{event_date} - {event_name} ({count} Ð¼ÐµÑÑ‚ Ð·Ð°Ð½ÑÑ‚Ð¾)"
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"event:{event_name}")])
    keyboard.append([InlineKeyboardButton("ðŸ”™ÐÐ°Ð·Ð°Ð´", callback_data="main_menu")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    if message_id:
        context.bot.edit_message_text(
            'ðŸŽ¥ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÑƒÐ»ÑŒÑ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÐ¼Ñ‹ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¼ÐµÑÑ‚Ð°Ñ… Ð›Ð¸Ð¼Ð°ÑÑÐ¾Ð»Ð°. \nÐ¡Ð»ÐµÐ´Ð¸Ñ‚Ðµ Ð·Ð° Ð°Ñ„Ð¸ÑˆÐµÐ¹\nÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ: Ñ€ÐµÐ²Ð¾Ð»ÑŽÑ‚ @aleksa74gd\nÐ§Ð°Ñ‚: https://t.me/outdoor_cinema_cy\nÐ¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾, Ð°Ñ€ÐµÐ½Ð´Ð° Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ @limarockstar\nðŸ‡¨ðŸ‡¾ÐšÐ¸Ð¿Ñ€, Ð›Ð¸Ð¼Ð°ÑÑÐ¾Ð»\nÐ‘Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ðµ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ:',
            chat_id=update.effective_chat.id,
            message_id=message_id,
            reply_markup=reply_markup
        )
    else:
        update.message.reply_text(
            'ðŸŽ¥ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÑƒÐ»ÑŒÑ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÐ¼Ñ‹ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¼ÐµÑÑ‚Ð°Ñ… Ð›Ð¸Ð¼Ð°ÑÑÐ¾Ð»Ð°. \nÐ¡Ð»ÐµÐ´Ð¸Ñ‚Ðµ Ð·Ð° Ð°Ñ„Ð¸ÑˆÐµÐ¹\nÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ: Ñ€ÐµÐ²Ð¾Ð»ÑŽÑ‚ @aleksa74gd\nÐ§Ð°Ñ‚: https://t.me/outdoor_cinema_cy\nÐ¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾, Ð°Ñ€ÐµÐ½Ð´Ð° Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ @limarockstar\nðŸ‡¨ðŸ‡¾ÐšÐ¸Ð¿Ñ€, Ð›Ð¸Ð¼Ð°ÑÑÐ¾Ð»\nÐ‘Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ðµ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ:',
            reply_markup=reply_markup
        )

# Telegram Bot: Callback function
def event_callback(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    query.answer()
    event_type = query.data.split(":", 1)[0]
    event_name = query.data.split(":", 1)[1] if ":" in query.data else None
    user = update.effective_user

    if event_type == 'event':
        delete_last_message(context, update)
        event = next((e for e in fetch_events() if e['name'] == event_name), None)
        if event:
            keyboard = [
                [InlineKeyboardButton("ðŸ“Ð—Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ", callback_data=f"register:{event_name}")],
                [InlineKeyboardButton("ðŸ”™ÐÐ°Ð·Ð°Ð´", callback_data="back")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            query.edit_message_text(f"ðŸ¿{event_name}:\n\b{event['description']}",
                                    reply_markup=reply_markup)
    elif event_type == 'show_events':
        show_events(update, context, message_id=query.message.message_id)
    elif event_type == 'personal_cabinet':
        show_personal_cabinet(update, context)
    elif event_type == 'main_menu':
        delete_last_message(context, update)
        start(update, context)
    elif event_type == 'cancel':
        delete_last_message(context, update)
        cancel_booking(user, event_name)  # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹ Ð±Ñ€Ð¾Ð½Ð¸
        query.edit_message_text(f"Ð‘Ñ€Ð¾Ð½ÑŒ Ð½Ð° Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ {event_name} Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°.")
        show_personal_cabinet(update, context)  # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚

    elif event_type == 'register':
        delete_last_message(context, update)
        keyboard = [
            [InlineKeyboardButton("1", callback_data=f"seats:1:{event_name}"),
             InlineKeyboardButton("2", callback_data=f"seats:2:{event_name}"),
             InlineKeyboardButton("3", callback_data=f"seats:3:{event_name}")],
            [InlineKeyboardButton("4", callback_data=f"seats:4:{event_name}"),
             InlineKeyboardButton("5", callback_data=f"seats:5:{event_name}"),
             InlineKeyboardButton("6", callback_data=f"seats:6:{event_name}")],
            [InlineKeyboardButton("ðŸ”™ÐÐ°Ð·Ð°Ð´", callback_data="back")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        query.edit_message_text(f"ðŸ°Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼ÐµÑÑ‚ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð·Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ð° {event_name}?", reply_markup=reply_markup)
    elif event_type == 'seats':
        delete_last_message(context, update)
        parts = query.data.split(":")
        seats = parts[1]
        event_name = ":".join(parts[2:])  # Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð²ÑÐµ, Ñ‡Ñ‚Ð¾ Ð¸Ð´ÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð´Ð²Ð¾ÐµÑ‚Ð¾Ñ‡Ð¸Ñ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² ÑÑ‚Ñ€Ð¾ÐºÑƒ
        keyboard = [
            [InlineKeyboardButton("ðŸ’¸ÐÐ°Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð½Ð° Ð¼ÐµÑÑ‚Ðµ", callback_data=f"pay_cash:{event_name}:{seats}")],
            [InlineKeyboardButton("ðŸ’³ÐžÐ½Ð»Ð°Ð¹Ð½", callback_data=f"pay_online:{event_name}:{seats}")],
            [InlineKeyboardButton("ðŸ”™ÐÐ°Ð·Ð°Ð´", callback_data="back")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        query.edit_message_text(f"ðŸ°ÐšÐ°Ðº Ð±Ñ‹ Ð²Ñ‹ Ñ…Ð¾Ñ‚ÐµÐ»Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ {seats} Ð¼ÐµÑÑ‚ Ð½Ð° Ñ„Ð¸Ð»ÑŒÐ¼ {event_name}?", reply_markup=reply_markup)


    elif event_type in ['pay_cash', 'pay_online']:
        delete_last_message(context, update)
        parts = query.data.split(":")
        seats = parts[-1]
        event_name = ":".join(
            parts[1:-1])  # Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð²ÑÐµ, Ñ‡Ñ‚Ð¾ Ð¸Ð´ÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð¸ Ð´Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð´Ð²Ð¾ÐµÑ‚Ð¾Ñ‡Ð¸Ñ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² ÑÑ‚Ñ€Ð¾ÐºÑƒ
        status = 'ðŸ’¸Ð½Ð°Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸' if event_type == 'pay_cash' else 'ðŸ’³Ð¾Ð½Ð»Ð°Ð¹Ð½'
        add_or_update_registration_to_sheet(user, event_name, status, seats)
        last_message_id = context.user_data.get('last_message_id')
        if last_message_id:
            context.bot.delete_message(chat_id=update.effective_chat.id, message_id=last_message_id)
            del context.user_data['last_message_id']
        if event_type == 'pay_cash':
            text = f"ÐœÑ‹ Ð·Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¸ ðŸ“ Ð²Ð°Ð¼ {seats} Ð¼ÐµÑÑ‚ Ð½Ð° Ñ„Ð¸Ð»ÑŒÐ¼: {event_name}.\nÐ¡Ð¿Ð¾ÑÐ¾Ð± Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹: {status}"
            keyboard = [[InlineKeyboardButton("ðŸ”™ÐÐ°Ð·Ð°Ð´", callback_data=f"back:{event_name}")]]
            reply_markup = InlineKeyboardMarkup(keyboard)
            query.edit_message_text(text, reply_markup=reply_markup)

        else:
            text = ("Ð¡Ð¿Ð¾ÑÐ¾Ð±Ñ‹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹:\n"
                    "1. Telegram Bot: https://t.me/outcy/159\n"
                    "2. Revolut: @aleksa74gd\n"
                    "3. Patreon: https://www.patreon.com/OUTDOORCINEMA\n"
                    "ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ðŸ‘©ðŸ» @qeaqa, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ð°Ñ Ð²Ð½ÐµÑÐ»Ð¸ Ð² ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ ÐºÐ¸Ð´Ð°Ð¹Ñ‚Ðµ ÐµÐ¹ ÑÐºÑ€Ð¸Ð½ ÑÐºÑ€Ð°Ð½Ð°")
            keyboard = [
                [InlineKeyboardButton("ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ", callback_data=f"check_status:{event_name}")],
                [InlineKeyboardButton("ðŸ”™ÐÐ°Ð·Ð°Ð´", callback_data=f"back:{event_name}")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            query.edit_message_text(text, reply_markup=reply_markup)

    elif event_type == 'check_status':
        delete_last_message(context, update)
        text = f"ðŸŽ¬Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð´Ð»Ñ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ: {event_name} Ð¿Ð¾ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ÑÑ. \nÐ’ Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð²Ð°Ð¼ Ð½Ð°Ð¿Ð¸ÑˆÐµÑ‚ ðŸ‘©ðŸ» @qeaqa"
        keyboard = [[InlineKeyboardButton("ðŸ”™ÐÐ°Ð·Ð°Ð´", callback_data=f"back:{event_name}")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        query.edit_message_text(text, reply_markup=reply_markup)

    elif event_type == 'back':
        delete_last_message(context, update)
        add_or_update_registration_to_sheet(user, event_name, 'back')
        show_events(update, context, message_id=query.message.message_id)

# Telegram Bot: Show Events List
def fetch_user_bookings(user_id):
    SPREADSHEET_ID = '1MTV8EcGxH4LGVPZdsJeOAzfDLvo7D0MVN3itdaG5FzQ'
    RANGE_NAME = 'Sheet2!A2:D'
    result = sheet.values().get(spreadsheetId=SPREADSHEET_ID, range=RANGE_NAME).execute()
    values = result.get('values', [])

    user_bookings = {}
    for row in values:
        if row[0] == user_id:
            event_name = row[1]
            payment_status = row[2]
            if payment_status == 'back':  # Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÐ¸ ÑÐ¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð¼ 'back'
                continue
            tickets_count = int(row[3])
            if event_name not in user_bookings:
                user_bookings[event_name] = {}
            user_bookings[event_name][payment_status] = tickets_count

    return user_bookings
def cancel_booking(user, event_name):
    user_identifier = f"@{user.username}" if user.username else str(user.id)
    SPREADSHEET_ID = '1MTV8EcGxH4LGVPZdsJeOAzfDLvo7D0MVN3itdaG5FzQ'
    RANGE_NAME = 'Sheet2!A2:D'
    result = sheet.values().get(spreadsheetId=SPREADSHEET_ID, range=RANGE_NAME).execute()
    values = result.get('values', [])
    for i, row in enumerate(values):
        if row[0] == user_identifier and row[1] == event_name:
            row[3] = "0"  # Setting the status to "0" to indicate cancellation
            row[1] = ""  # Setting the status to "" to indicate cancellation
            sheet.values().update(
                spreadsheetId=SPREADSHEET_ID,
                range=f'Sheet2!A{i + 2}:D{i + 2}',
                body={"values": [row]},
                valueInputOption='RAW'
            ).execute()
            break
def fetch_events():
    SPREADSHEET_ID = '1MTV8EcGxH4LGVPZdsJeOAzfDLvo7D0MVN3itdaG5FzQ'
    RANGE_NAME = 'Sheet1!A2:E10'
    result = sheet.values().get(spreadsheetId=SPREADSHEET_ID, range=RANGE_NAME).execute()
    values = result.get('values', [])
    events = [{"date": row[0], "name": row[1], "description": row[2], "attachment": row[3] if len(row) > 3 else None} for row in values]
    return events

# Fetch registered users count for each event from Google Sheets
def fetch_registered_users_count():
    SPREADSHEET_ID = '1MTV8EcGxH4LGVPZdsJeOAzfDLvo7D0MVN3itdaG5FzQ'
    RANGE_NAME = 'Sheet2!A2:D'
    result = sheet.values().get(spreadsheetId=SPREADSHEET_ID, range=RANGE_NAME).execute()
    values = result.get('values', [])
    event_count = {}
    for row in values:
        if len(row) >= 4 and row[2] in ['ðŸ’¸Ð½Ð°Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸', 'ðŸ’³Ð¾Ð½Ð»Ð°Ð¹Ð½']:
            event_name = row[1]
            seats = int(row[3])
            if event_name not in event_count:
                event_count[event_name] = 0
            event_count[event_name] += seats
    return event_count

# Add or Update registration to Google Sheets
def add_or_update_registration_to_sheet(user, event_name, status, seats=1):
    if seats is not None:
        seats = int(seats)
    user_identifier = f"@{user.username}" if user.username else str(user.id)
    SPREADSHEET_ID = '1MTV8EcGxH4LGVPZdsJeOAzfDLvo7D0MVN3itdaG5FzQ'
    RANGE_NAME = 'Sheet2!A2:D'
    result = sheet.values().get(spreadsheetId=SPREADSHEET_ID, range=RANGE_NAME).execute()
    values = result.get('values', [])

    if status in ['ðŸ’¸Ð½Ð°Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸', 'ðŸ’³Ð¾Ð½Ð»Ð°Ð¹Ð½']:  # Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ
        new_row = [user_identifier, event_name, status, str(seats)]
        sheet.values().append(
            spreadsheetId=SPREADSHEET_ID,
            range=RANGE_NAME,
            body={"values": [new_row]},
            valueInputOption='RAW'
        ).execute()
    else:  # Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð² Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»
        found = False
        for i, row in enumerate(values):
            if row[0] == user_identifier and row[1] == event_name and status != 'back':
                row[2] = status
                row[3] = str(int(row[3]) + seats)
                sheet.values().update(
                    spreadsheetId=SPREADSHEET_ID,
                    range=f'Sheet2!A{i + 2}:D{i + 2}',
                    body={"values": [row]},
                    valueInputOption='RAW'
                ).execute()
                found = True
                break
        if not found or status == 'back':
            new_row = [user_identifier, event_name, status, str(seats)]
            sheet.values().append(
                spreadsheetId=SPREADSHEET_ID,
                range=RANGE_NAME,
                body={"values": [new_row]},
                valueInputOption='RAW'
            ).execute()

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¾ ÐµÑÑ‚ÑŒ
def delete_last_message(context, update):
    last_message_id = context.user_data.get('last_message_id')
    if last_message_id:
        try:
            context.bot.delete_message(chat_id=update.effective_chat.id, message_id=last_message_id)
        except telegram.error.BadRequest:
            pass
        del context.user_data['last_message_id']

# Main function
def main() -> None:
    updater = Updater("6551047772:AAE3CNw2mvx1su-qN1AFqHaII49Vxbg3pCo")
    dp = updater.dispatcher
    dp.add_handler(CommandHandler('start', start))
    dp.add_handler(CallbackQueryHandler(event_callback))
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
